# ドローンコントローラの数理理論

このドキュメントでは、`genesis_drones`パッケージで実装されているドローンコントローラの数理理論について説明します。

## 目次

1. [PIDコントローラ](#pid-controller)
2. [CTBRコントローラ](#ctbr-controller)
3. [ハイブリッドコントローラ](#hybrid-controller)
4. [ミキサーマトリックス](#mixer-matrix)

## PIDコントローラ <a name="pid-controller"></a>

### 基本原理

PID（比例-積分-微分）制御は、以下の3つの要素を組み合わせたフィードバック制御手法です：

1. **比例項（P）**: 現在の誤差に比例した制御入力を生成
2. **積分項（I）**: 過去の誤差の累積に比例した制御入力を生成
3. **微分項（D）**: 誤差の変化率に比例した制御入力を生成

PID制御の数式は以下のように表されます：

$$u(t) = K_p e(t) + K_i \int_{0}^{t} e(\tau) d\tau + K_d \frac{de(t)}{dt}$$

ここで：
- $u(t)$ は制御入力
- $e(t)$ は目標値と現在値の誤差
- $K_p$, $K_i$, $K_d$ はそれぞれ比例、積分、微分ゲイン

### ドローン制御への応用

ドローンの制御では、位置、速度、姿勢の各要素に対してPID制御を適用します：

1. **位置制御**: 目標位置と現在位置の誤差から目標速度を計算
2. **速度制御**: 目標速度と現在速度の誤差から目標加速度（推力）を計算
3. **姿勢制御**: 目標姿勢と現在姿勢の誤差から角速度を計算

これらの制御ループをカスケード接続することで、安定した飛行制御を実現します。

### 実装の特徴

`DronePIDController`クラスでは、以下の特徴を持つPID制御を実装しています：

- 3次元空間での位置制御（x, y, z軸）
- 3次元空間での速度制御（x, y, z軸）
- 3次元空間での姿勢制御（ロール、ピッチ、ヨー）
- カスケード制御構造（位置→速度→姿勢）
- 各制御ループに独立したPIDパラメータ

## CTBRコントローラ <a name="ctbr-controller"></a>

### 基本原理

CTBR（Control Toolbox Based Regulator）は、四元数を用いた姿勢制御を特徴とするコントローラです。主な特徴は以下の通りです：

1. **四元数による姿勢表現**: オイラー角のジンバルロック問題を回避
2. **目標加速度からの姿勢計算**: 位置・速度制御から直接姿勢を導出
3. **四元数誤差に基づく角速度制御**: 滑らかな姿勢制御を実現

### 数学的基礎

#### 四元数

四元数 $q = [q_w, q_x, q_y, q_z]$ は、3次元空間での回転を表現するために使用されます。四元数の利点は、ジンバルロックを回避し、連続的な回転を表現できることです。

#### 目標姿勢の計算

CTBRコントローラでは、目標加速度ベクトル $\vec{a}_{des}$ から目標姿勢を計算します：

1. 目標加速度から機体のz軸方向を計算：
   $$\vec{z}_{body} = \frac{\vec{a}_{des}}{|\vec{a}_{des}|}$$

2. 基準となるy軸（通常は上方向）との外積から機体のx軸方向を計算：
   $$\vec{x}_{body} = \frac{\vec{y}_{ref} \times \vec{z}_{body}}{|\vec{y}_{ref} \times \vec{z}_{body}|}$$

3. z軸とx軸の外積から機体のy軸方向を計算：
   $$\vec{y}_{body} = \frac{\vec{z}_{body} \times \vec{x}_{body}}{|\vec{z}_{body} \times \vec{x}_{body}|}$$

4. 回転行列から四元数を計算：
   $$R = [\vec{x}_{body}, \vec{y}_{body}, \vec{z}_{body}]$$
   $$q_{des} = \text{quaternion\_from\_matrix}(R)$$

#### 姿勢制御

現在の姿勢 $q_{current}$ と目標姿勢 $q_{des}$ の間の誤差四元数を計算：

$$q_{error} = q_{current}^{-1} \otimes q_{des}$$

この誤差四元数から角速度指令値を計算：

$$\vec{\omega} = 2 K_{\omega} \cdot [q_{error,x}, q_{error,y}, q_{error,z}] \cdot \text{sign}(q_{error,w})$$

ここで $K_{\omega}$ は角速度ゲインです。

### 実装の特徴

`CTBRController`クラスでは、以下の特徴を持つCTBR制御を実装しています：

- 四元数を用いた姿勢表現と制御
- 目標加速度から直接姿勢を計算
- 位置・速度制御と姿勢制御の統合
- ミキサーマトリックスによるモーター出力の計算

## ハイブリッドコントローラ <a name="hybrid-controller"></a>

### 基本原理

ハイブリッドコントローラは、PIDコントローラとCTBRコントローラの利点を組み合わせたコントローラです。主な特徴は以下の通りです：

1. **位置・速度制御**: PID制御を使用
2. **姿勢制御**: CTBRの四元数ベースの制御を使用
3. **切り替え可能なモード**: 完全PID制御とハイブリッド制御の切り替えが可能

### 制御フロー

ハイブリッドコントローラの制御フローは以下の通りです：

1. **位置制御（PID）**: 目標位置と現在位置の誤差から目標速度を計算
2. **速度制御（PID）**: 目標速度と現在速度の誤差から目標加速度を計算
3. **姿勢制御（モードに依存）**:
   - **ハイブリッドモード**: 目標加速度から四元数ベースの姿勢制御（CTBR）
   - **完全PIDモード**: オイラー角ベースの姿勢制御（PID）
4. **モーター出力計算**: ミキサーマトリックスを使用してRPMを計算

### 実装の特徴

`HybridController`クラスでは、以下の特徴を持つハイブリッド制御を実装しています：

- PIDベースの位置・速度制御
- 切り替え可能な姿勢制御（CTBR/PID）
- 柔軟なパラメータ設定
- 適応的な制御モード選択

## ミキサーマトリックス <a name="mixer-matrix"></a>

### 基本原理

ミキサーマトリックスは、制御入力（推力、ロール、ピッチ、ヨー）をモーター出力（RPM）に変換するための行列です。クアッドコプターの場合、4つのモーターの出力を適切に組み合わせることで、3次元空間での6自由度の動きを制御します。

### 数学的表現

ミキサーマトリックス $M$ を使用して、制御入力ベクトル $\vec{u}$ からモーター出力ベクトル $\vec{m}$ を計算します：

$$\vec{m} = M \cdot \vec{u} + \vec{m}_{base}$$

ここで：
- $\vec{u} = [thrust, roll, pitch, yaw]^T$ は制御入力
- $\vec{m} = [m_1, m_2, m_3, m_4]^T$ はモーター出力（RPM）
- $\vec{m}_{base}$ は基準RPM（ホバリング時のRPM）

### X型クアッドコプターのミキサーマトリックス

X型のクアッドコプター（プロペラが「X」の形に配置）の場合、ミキサーマトリックスは以下のようになります：

$$M = \begin{bmatrix}
1 & -1 & -1 & -1 \\
1 & -1 & 1 & 1 \\
1 & 1 & 1 & -1 \\
1 & 1 & -1 & 1
\end{bmatrix}$$

この行列は、各モーターが推力、ロール、ピッチ、ヨーにどのように寄与するかを表しています。例えば、ロールを正の方向に回転させるには、モーター3と4の出力を増加させ、モーター1と2の出力を減少させます。

### 実装の特徴

各コントローラクラスでは、以下の特徴を持つミキサー実装を提供しています：

- X型クアッドコプターのミキサーマトリックス
- 基準RPMからの相対的な出力計算
- RPM制限機能（最小・最大RPMの範囲内に制限）
- 異なる制御アルゴリズムに対応した柔軟なミキサー実装
